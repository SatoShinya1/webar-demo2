<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ARアニメーション選択</title>
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>
  <script src="cdn.tailwindcss.com"></script>
  <style>
    html,body{margin:0;padding:0;overflow:hidden;width:100%;height:100%;font-family:'Inter',sans-serif;box-sizing:border-box}
    #ar-container,#selection-menu{width:100%;height:100%}
    a-scene[embedded],.a-canvas,video{position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;margin:0!important;padding:0!important}
    a-scene[embedded],.a-canvas{z-index:1}
    video{object-fit:cover!important;z-index:-1}
    #btn-back{z-index:10!important}
  </style>
</head>
<body class="bg-black">
  <div id="selection-menu" class="flex flex-col items-center justify-center p-8 space-y-6 bg-gray-100">
    <h1 class="text-3xl font-bold text-gray-800 mb-4">ARアニメーションを選択</h1>
    <button data-type="left" class="w-full max-w-sm p-4 bg-blue-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-blue-600 transition">左に行く</button>
    <button data-type="right" class="w-full max-w-sm p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-green-600 transition">右に行く</button>
    <button data-type="approach" class="w-full max-w-sm p-4 bg-yellow-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-yellow-600 transition">近づく</button>
    <button data-type="away" class="w-full max-w-sm p-4 bg-red-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-red-600 transition">遠ざかる</button>
  </div>

  <div id="ar-container" class="hidden relative">
    <a-scene embedded
      arjs="sourceType: webcam; debugUIEnabled: false;
            sourceParameters: { video: { width: { ideal: 1280 }, height: { ideal: 960 }, facingMode: { ideal: 'environment' } } }">
      <!-- emitevents を付けて markerFound / markerLost を受け取る -->
      <a-marker id="marker" type="pattern" url="pattern-Cat.patt" emitevents="true"></a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    <button id="btn-back" class="absolute bottom-6 left-1/2 -translate-x-1/2 p-3 bg-gray-800 text-white rounded-lg shadow-lg hover:bg-gray-900 transition">
      メニューに戻る
    </button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const menu = document.getElementById('selection-menu');
      const arContainer = document.getElementById('ar-container');
      const scene = document.querySelector('a-scene');
      const marker = document.getElementById('marker');
      const backButton = document.getElementById('btn-back');

      let placed = false;          // 1回だけ設置するためのフラグ
      let currentType = null;      // 選択したアニメーション種別
      let model = null;            // 生成したモデル参照
      let onFirstFound = null;     // リスナ参照（解除用）

      // メニューの各ボタン
      document.querySelectorAll('#selection-menu button').forEach(btn => {
        btn.addEventListener('click', () => {
          currentType = btn.getAttribute('data-type');
          startAR();
        });
      });

      backButton.addEventListener('click', showMenu);

      // マーカー姿勢を一度だけコピーしてモデルを出す
      function handleFirstMarkerFound() {
        if (placed) return;

        // モデル生成（初期は非表示でもOKだが、ここで作るのでvisibleデフォでOK）
        model = document.createElement('a-entity');
        model.setAttribute('id', 'current-model');
        model.setAttribute('gltf-model', 'bird3.glb');

        // マーカーのワールド行列をモデルにコピー
        copyMarkerWorldTransformTo(model);

        // 選択タイプに応じてアニメ設定
        applyAnimation(model, currentType);

        // シーン直下に追加（以後はマーカーと無関係）
        scene.appendChild(model);

        placed = true;

        // 一度限りのリスナーを解除
        if (onFirstFound) {
          marker.removeEventListener('markerFound', onFirstFound);
          onFirstFound = null;
        }
      }

      function startAR() {
        // 画面切替
        menu.classList.add('hidden');
        arContainer.classList.remove('hidden');
        setTimeout(() => window.dispatchEvent(new Event('resize')), 100);

        // 前回の残骸クリア
        cleanupModel();

        placed = false;

        // 一回だけ発火する markerFound リスナー
        onFirstFound = handleFirstMarkerFound;
        marker.addEventListener('markerFound', onFirstFound, { once: true });
      }

      function showMenu() {
        arContainer.classList.add('hidden');
        menu.classList.remove('hidden');
        cleanupModel();
        placed = false;
        currentType = null;
        if (onFirstFound) {
          marker.removeEventListener('markerFound', onFirstFound);
          onFirstFound = null;
        }
      }

      function cleanupModel() {
        const existing = document.getElementById('current-model');
        if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
        model = null;
      }

      // マーカーのワールド姿勢を entity にコピー
      function copyMarkerWorldTransformTo(entity) {
        const mObj = marker.object3D;
        const eObj = entity.object3D;
        // matrixWorld を分解して position/rotation/scale を反映
        eObj.matrix.copy(mObj.matrixWorld);
        eObj.matrix.decompose(eObj.position, eObj.quaternion, eObj.scale);
      }

      // 種別ごとのアニメ設定（以後はマーカーと無関係に動く）
      function applyAnimation(entity, type) {
        switch (type) {
          case 'left': // -X にループ移動
            entity.setAttribute('rotation', '0 0 90');
            entity.setAttribute('scale', '3 3 3');
            entity.setAttribute('animation', {
              property: 'position',
              to: '-5 0 0',
              dur: 4000,
              dir: 'alternate',
              loop: true
            });
            break;
          case 'right': // +X にループ移動
            entity.setAttribute('rotation', '0 0 -90');
            entity.setAttribute('scale', '3 3 3');
            entity.setAttribute('animation', {
              property: 'position',
              to: '5 0 0',
              dur: 4000,
              dir: 'alternate',
              loop: true
            });
            break;
          case 'approach': // 拡大
            entity.setAttribute('rotation', '0 0 0');
            entity.setAttribute('scale', '1 1 1');
            entity.setAttribute('animation', {
              property: 'scale',
              from: '1 1 1',
              to: '10 10 10',
              dur: 15000,
              loop: false
            });
            break;
          case 'away': // 縮小
            entity.setAttribute('rotation', '0 0 180');
            entity.setAttribute('scale', '10 10 10');
            entity.setAttribute('animation', {
              property: 'scale',
              from: '10 10 10',
              to: '1 1 1',
              dur: 20000,
              loop: false
            });
            break;
        }
      }
    });
  </script>
</body>
</html>
