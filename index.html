<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARアニメーション選択</title>
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>
  <script src="cdn.tailwindcss.com"></script>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; width:100%; height:100%; font-family:'Inter', sans-serif; box-sizing:border-box; }
    #ar-container, #selection-menu { width:100%; height:100%; margin:0; padding:0; }
    a-scene[embedded], .a-canvas, video {
      width:100%!important; height:100%!important; position:absolute!important; top:0!important; left:0!important; margin:0!important; padding:0!important;
    }
    a-scene[embedded], .a-canvas { z-index:1; }
    video { object-fit:cover!important; z-index:-1; }
    #btn-back { z-index:10!important; }
  </style>
</head>
<body class="bg-black">
  <div id="selection-menu" class="flex flex-col items-center justify-center p-8 space-y-6 bg-gray-100">
    <h1 class="text-3xl font-bold text-gray-800 mb-4">ARアニメーションを選択</h1>
    <button id="btn-left" data-type="left" class="w-full max-w-sm p-4 bg-blue-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-blue-600 transition duration-200">左に行く</button>
    <button id="btn-right" data-type="right" class="w-full max-w-sm p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-green-600 transition duration-200">右に行く</button>
    <button id="btn-approach" data-type="approach" class="w-full max-w-sm p-4 bg-yellow-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-yellow-600 transition duration-200">近づく</button>
    <button id="btn-away" data-type="away" class="w-full max-w-sm p-4 bg-red-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-red-600 transition duration-200">遠ざかる</button>
  </div>

  <div id="ar-container" class="hidden relative">
    <a-scene embedded
      arjs="sourceType: webcam; debugUIEnabled: false;
            sourceParameters: { video: { width: { ideal: 1280 }, height: { ideal: 960 }, facingMode: { ideal: 'environment' } } }">
      <!-- 変更点: emitevents を付けて markerFound / markerLost を受け取る -->
      <a-marker id="marker" type="pattern" url="pattern-Cat.patt" emitevents="true"></a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    <button id="btn-back" class="absolute bottom-6 left-1/2 -translate-x-1/2 z-10 p-3 bg-gray-800 text-white rounded-lg shadow-lg hover:bg-gray-900 transition duration-200">
      メニューに戻る
    </button>
  </div>

  <script>
    // 変更点: マーカーの姿勢をモデルへ同期する A-Frame コンポーネント
    AFRAME.registerComponent('follow-marker', {
      schema: { markerId: { type: 'string', default: 'marker' } },
      init: function () {
        this.marker = document.getElementById(this.data.markerId);
        this.follow = false;
        this.copyTransform = () => {
          if (!this.marker) return;
          const m = this.marker.object3D;
          const o = this.el.object3D;
          // マーカーのワールド行列をモデルに反映
          o.matrix.copy(m.matrixWorld);
          o.matrix.decompose(o.position, o.quaternion, o.scale);
        };
        this.marker.addEventListener('markerFound', () => { this.follow = true; this.copyTransform(); });
        this.marker.addEventListener('markerLost',  () => { this.follow = false; /* 同期停止 → その場に残る */ });
      },
      tick: function () {
        if (this.follow) this.copyTransform(); // 見えている間だけ追従
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const menu = document.getElementById('selection-menu');
      const arContainer = document.getElementById('ar-container');
      const marker = document.getElementById('marker');
      const backButton = document.getElementById('btn-back');
      const selectionButtons = document.querySelectorAll('#selection-menu button');
      const scene = document.querySelector('a-scene');

      selectionButtons.forEach(button => {
        button.addEventListener('click', () => {
          const animationType = button.getAttribute('data-type');
          startAR(animationType);
        });
      });

      backButton.addEventListener('click', () => { showMenu(); });

      function startAR(type) {
        // 変更点: 既存モデルは親から remove（marker固定ではなくなったため）
        const existingModel = document.getElementById('current-model');
        if (existingModel && existingModel.parentNode) {
          existingModel.parentNode.removeChild(existingModel);
        }

        // 新しいモデルエンティティを作成（シーン直下に置く）
        const model = document.createElement('a-entity');
        model.setAttribute('id', 'current-model');
        model.setAttribute('gltf-model', 'bird3.glb');

        // マーカー追従コンポーネントを付与（ロスト後はその場に残る）
        model.setAttribute('follow-marker', 'markerId: marker');

        // 選択タイプごとの初期設定
        switch (type) {
          case 'left': // 右へ移動
            model.setAttribute('rotation', '0 0 90');
            model.setAttribute('scale', '3 3 3');
            model.setAttribute('animation', {
              property: 'position',
              from: '0 0 0',
              to: '-5 0 0',
              dur: 4000,
              dir: 'normal',
              loop: true
            });
            break;

          case 'right': // 左へ移動
            model.setAttribute('rotation', '0 0 -90');
            model.setAttribute('scale', '3 3 3');
            model.setAttribute('animation', {
              property: 'position',
              from: '0 0 0',
              to: '5 0 0',
              dur: 4000,
              dir: 'normal',
              loop: true
            });
            break;

          case 'approach':
            model.setAttribute('rotation', '0 0 0');
            model.setAttribute('scale', '1 1 1');
            model.setAttribute('animation', {
              property: 'scale',
              from: '1 1 1',
              to: '10 10 10',
              dur: 15000,
              loop: false
            });
            break;

          case 'away':
            model.setAttribute('rotation', '0 0 180');
            model.setAttribute('scale', '10 10 10');
            model.setAttribute('animation', {
              property: 'scale',
              from: '10 10 10',
              to: '1 1 1',
              dur: 20000,
              loop: false
            });
            break;
        }

        // 変更点: モデルは a-scene 直下に追加（＝マーカーの子にしない）
        scene.appendChild(model);

        // 画面切替
        menu.classList.add('hidden');
        arContainer.classList.remove('hidden');
        setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
      }

      function showMenu() {
        arContainer.classList.add('hidden');
        menu.classList.remove('hidden');
        const existingModel = document.getElementById('current-model');
        if (existingModel && existingModel.parentNode) {
          existingModel.parentNode.removeChild(existingModel);
        }
      }
    });
  </script>
</body>
</html>
