<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ARアニメーション選択</title>
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>
  <script src="cdn.tailwindcss.com"></script>
  <style>
    html,body{margin:0;padding:0;overflow:hidden;width:100%;height:100%;font-family:'Inter',sans-serif;box-sizing:border-box}
    #ar-container,#selection-menu{width:100%;height:100%}
    a-scene[embedded],.a-canvas,video{position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;margin:0!important;padding:0!important}
    a-scene[embedded],.a-canvas{z-index:1}
    video{object-fit:cover!important;z-index:-1}
    #btn-back{z-index:10!important}
  </style>
</head>
<body class="bg-black">
  <div id="selection-menu" class="flex flex-col items-center justify-center p-8 space-y-6 bg-gray-100">
    <h1 class="text-3xl font-bold text-gray-800 mb-4">ARアニメーションを選択</h1>
    <button data-type="left" class="w-full max-w-sm p-4 bg-blue-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-blue-600 transition">左に行く</button>
    <button data-type="right" class="w-full max-w-sm p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-green-600 transition">右に行く</button>
    <button data-type="approach" class="w-full max-w-sm p-4 bg-yellow-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-yellow-600 transition">近づく</button>
    <button data-type="away" class="w-full max-w-sm p-4 bg-red-500 text-white rounded-lg shadow-md text-lg font-semibold hover:bg-red-600 transition">遠ざかる</button>
  </div>

  <div id="ar-container" class="hidden relative">
    <a-scene embedded
      arjs="sourceType: webcam; debugUIEnabled: false;
            sourceParameters: { video: { width: { ideal: 1280 }, height: { ideal: 960 }, facingMode: { ideal: 'environment' } } }">
      <!-- emitevents を付けて markerFound / markerLost を受け取る -->
      <a-marker id="marker" type="pattern" url="pattern-Cat.patt" emitevents="true"></a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    <button id="btn-back" class="absolute bottom-6 left-1/2 -translate-x-1/2 p-3 bg-gray-800 text-white rounded-lg shadow-lg hover:bg-gray-900 transition">
      メニューに戻る
    </button>
  </div>

  <script>
    // 追加: THREEのベクトル→A-Frame属性文字列
    function vecToAttr(v){ return `${v.x} ${v.y} ${v.z}`; }

    // 追加: marker.matrixWorldの回転成分からワールド軸ベクトルを得る
    function getWorldAxisFromMarker(markerObj3D, axis /* 'x' | 'y' | 'z' */){
        const m = new THREE.Matrix4();
        m.extractRotation(markerObj3D.matrixWorld);
        const v = new THREE.Vector3(
        axis === 'x' ? 1 : 0,
        axis === 'y' ? 1 : 0,
        axis === 'z' ? 1 : 0
        );
        v.applyMatrix4(m).normalize(); // ワールド方向ベクトル
        return v;
    }

    // 既存: マーカー姿勢を一度だけモデルへコピー
    function copyMarkerWorldTransformTo(entity) {
        const mObj = marker.object3D;
        const eObj = entity.object3D;
        eObj.matrix.copy(mObj.matrixWorld);
        eObj.matrix.decompose(eObj.position, eObj.quaternion, eObj.scale);
    }

    // ここを差し替え: “マーカーの向き”に沿ってP1を計算しpositionアニメ
    function applyAnimation(entity, type) {
        const eObj = entity.object3D;

        // 出現直後のワールド座標をfromにする
        const P0 = eObj.position.clone();

        // マーカー基準の左右方向をワールドに変換
        // left  = マーカーの -X 方向、right = +X 方向
        // approach/away は従来どおりスケールで演出（向きは保持）
        const moveDist = 5; // 任意の距離(調整可)

        if (type === 'left' || type === 'right') {
        const xAxis = getWorldAxisFromMarker(marker.object3D, 'x'); // +X
        const dir = (type === 'left') ? xAxis.clone().multiplyScalar(-1)
                                        : xAxis.clone();               // -X or +X
        const P1 = P0.clone().add(dir.multiplyScalar(moveDist));

        // マーカーの向きをそのまま使うので rotation は設定しない
        entity.setAttribute('scale', '3 3 3');
        entity.setAttribute('animation', {
            property: 'position',
            from: vecToAttr(P0),
            to: vecToAttr(P1),
            dur: 4000,
            dir: 'alternate',   // 行ったり来たり
            loop: true
        });
        return;
        }

        if (type === 'approach') {
        // 近づく演出はスケールのみ（向きは marker のまま）
        entity.setAttribute('scale', '1 1 1');
        entity.setAttribute('animation', {
            property: 'scale',
            from: '1 1 1',
            to: '10 10 10',
            dur: 15000,
            loop: false
        });
        return;
        }

        if (type === 'away') {
        entity.setAttribute('scale', '10 10 10');
        entity.setAttribute('animation', {
            property: 'scale',
            from: '10 10 10',
            to: '1 1 1',
            dur: 20000,
            loop: false
        });
        return;
        }
    }
  </script>

</body>
</html>
